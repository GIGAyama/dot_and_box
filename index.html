<!DOCTYPE html>
<html lang="ja">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‰ãƒƒãƒˆã‚¢ãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹</title>
    <!-- ä»¥å‰ã®ã‚¢ãƒ—ãƒªã¨å…±é€šã®ã€ä¸¸ã¿ã®ã‚ã‚‹ãƒ•ã‚©ãƒ³ãƒˆã‚’Google Fontsã‹ã‚‰èª­ã¿è¾¼ã¿ã¾ã™ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- styles.htmlã®å†…å®¹ã‚’ã“ã“ã«çµ±åˆ -->
    <style>
    /* ================================================================ */
    /* 1. åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«ã¨ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ */
    /* ================================================================ */

    /* è‰²ã®å®šç¾©ï¼šã“ã“ã§ã‚¢ãƒ—ãƒªå…¨ä½“ã®è‰²ã‚’ç®¡ç†ã—ã¾ã™ */
    :root {
        --font-family: 'M PLUS Rounded 1c', 'Hiragino Sans', 'Yu Gothic', sans-serif;
        --bg-color: #f0e7d8; /* èƒŒæ™¯è‰²ï¼šã™ã“ã—æ¸©ã‹ã¿ã®ã‚ã‚‹ãƒ™ãƒ¼ã‚¸ãƒ¥ */
        --container-bg: #fffaf0; /* ã‚³ãƒ³ãƒ†ãƒŠèƒŒæ™¯è‰²ï¼šãƒ•ãƒ­ãƒ¼ãƒ©ãƒ«ãƒ›ãƒ¯ã‚¤ãƒˆ */
        --text-color: #5d4037; /* ãƒ†ã‚­ã‚¹ãƒˆè‰²ï¼šæ¿ƒã„èŒ¶è‰² */
        --shadow-color: rgba(0, 0, 0, 0.1);
        --border-color: #dcdcdc;
        --dot-color: #444;

        /* ãƒ‰ãƒƒãƒˆã‚¢ãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹å°‚ç”¨ã®è‰² */
        --player1-color: #E57373; /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ï¼šèµ¤ */
        --player1-light: rgba(229, 115, 115, 0.3);
        --player2-color: #64B5F6; /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2ï¼šé’ */
        --player2-light: rgba(100, 181, 246, 0.3);
        --line-color: #e0e0e0; /* ã¾ã å¼•ã‹ã‚Œã¦ã„ãªã„ç·šã®è‰² */
        --line-hover: #cccccc;
        --btn-reset-bg: #f44336;
        --btn-undo-bg: #ff9800;
    }

    /* ãƒšãƒ¼ã‚¸å…¨ä½“ã®åŸºæœ¬è¨­å®š */
    body {
        font-family: var(--font-family);
        background-color: var(--bg-color);
        color: var(--text-color);
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        padding: 20px;
        box-sizing: border-box;
    }

    /* ã‚²ãƒ¼ãƒ å…¨ä½“ã‚’å›²ã‚€ã‚³ãƒ³ãƒ†ãƒŠ */
    #game-container {
        background-color: var(--container-bg);
        padding: 25px 40px;
        border-radius: 20px;
        box-shadow: 0 10px 30px var(--shadow-color);
        text-align: center;
        width: 100%;
        max-width: 550px;
    }

    .title {
        font-size: 2.2em;
        font-weight: 700;
        margin: 0 0 25px;
    }


    /* ================================================================ */
    /* 2. è¨­å®šç”»é¢ã¨ã‚²ãƒ¼ãƒ æƒ…å ±ã‚¨ãƒªã‚¢ */
    /* ================================================================ */
    #settings {
        margin: 20px 0;
        padding: 20px;
        background-color: #f9f9f9;
        border-radius: 12px;
        border: 1px solid var(--border-color);
    }
    #settings select, #settings button {
        font-family: inherit;
        padding: 10px;
        font-size: 16px;
        border-radius: 8px;
        border: 1px solid #ccc;
        margin: 0 5px;
    }
    #start-button {
        background-color: #4CAF50;
        color: white;
    }

    /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ã¨ã‚¹ã‚³ã‚¢è¡¨ç¤º */
    #info-panel {
        display: flex;
        justify-content: space-around;
        align-items: center;
        margin-bottom: 25px;
        font-size: 1.2em;
        background-color: #f9f9f9;
        padding: 10px 15px;
        border-radius: 12px;
        border: 1px solid var(--border-color);
    }
    .player-info {
        padding: 10px 20px;
        border-radius: 8px;
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }
    .player-info.active {
        font-weight: bold;
        transform: scale(1.05);
    }
    #player1-info.active {
        border-color: var(--player1-color);
        background-color: #fff;
    }
    #player2-info.active {
        border-color: var(--player2-color);
        background-color: #fff;
    }
    .score {
        font-weight: bold;
        margin-left: 8px;
    }


    /* ================================================================ */
    /* 3. ç›¤é¢ï¼ˆãƒ‰ãƒƒãƒˆã€ç·šã€ãƒœãƒƒã‚¯ã‚¹ï¼‰ */
    /* ================================================================ */

    #game-board {
        display: grid;
        margin: 20px auto; /* ä¸Šä¸‹ã«å°‘ã—ä½™ç™½ã‚’è¿½åŠ  */
        user-select: none; /* ãƒ†ã‚­ã‚¹ãƒˆé¸æŠã‚’é˜²ã */
        /* ãƒ‰ãƒƒãƒˆã¨ç·šãŒã´ã£ãŸã‚Šåˆã†ã‚ˆã†ã«ã€è¦ç´ ã‚’ä¸­å¤®æƒãˆã«ã—ã¾ã™ */
        align-items: center;
        justify-items: center;
    }

    .dot {
        width: 20px;
        height: 20px;
        background-color: var(--dot-color);
        border-radius: 50%; /* å††ã«ã™ã‚‹ */
        /* ç·šãŒãƒ‰ãƒƒãƒˆã®ä¸‹ã«æ½œã‚Šè¾¼ã‚€ã‚ˆã†ã«èª¿æ•´ */
        z-index: 5; 
        position: relative; /* z-indexã‚’æœ‰åŠ¹ã«ã™ã‚‹ãŸã‚ */
    }

    .line {
        background-color: var(--line-color);
        cursor: pointer;
        transition: background-color 0.2s;
        /* ç·šãŒãƒ‰ãƒƒãƒˆã®ä¸­å¿ƒã«æ¥ç¶šã™ã‚‹ã‚ˆã†ã«èª¿æ•´ */
        border-radius: 5px; /* ç·šã®è§’ã‚’ä¸¸ãã™ã‚‹ */
    }
    .line:hover {
        background-color: var(--line-hover);
    }

    /* æ¨ªç·šã¨ç¸¦ç·šã®ã‚µã‚¤ã‚ºã¨ä½ç½®ã‚’èª¿æ•´ */
    .horizontal { 
        width: 100%; /* ã‚»ãƒ«ã®å¹…ã„ã£ã±ã„ã«åºƒãŒã‚‹ */
        height: 10px; /* ç·šã®å¤ªã• */
    }
    .vertical { 
        width: 10px; /* ç·šã®å¤ªã• */
        height: 100%; /* ã‚»ãƒ«ã®é«˜ã•ã«åºƒãŒã‚‹ */
    }

    /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå¼•ã„ãŸç·šã®è‰² */
    .line.player1 { background-color: var(--player1-color); }
    .line.player2 { background-color: var(--player2-color); }
    /* ã€Œä¸€æ‰‹æˆ»ã™ã€ã§å¾©å…ƒã•ã‚ŒãŸç·šï¼ˆèª°ãŒå¼•ã„ãŸã‹ä¸æ˜ãªãŸã‚ï¼‰ */
    .line.player-restored { background-color: var(--dot-color); }

    .box-placeholder {
        width: 100%;  /* ã‚»ãƒ«ã®å¹…ã„ã£ã±ã„ã« */
        height: 100%; /* ã‚»ãƒ«ã®é«˜ã•ã« */
        transition: background-color 0.5s;
    }
    .filled-player1 { background-color: var(--player1-light); }
    .filled-player2 { background-color: var(--player2-light); }


    /* ================================================================ */
    /* 4. æ“ä½œãƒœã‚¿ãƒ³ã¨ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ */
    /* ================================================================ */
    #controls {
        margin-top: 25px;
    }
    .btn {
        font-family: var(--font-family);
        color: white;
        border: none;
        padding: 10px 20px;
        font-size: 1em;
        font-weight: 700;
        border-radius: 8px;
        cursor: pointer;
        margin: 0 10px;
        transition: all 0.2s;
    }
    .btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .btn:disabled {
        background-color: #ccc;
        cursor: not-allowed;
    }

    #start-button { background-color: #4CAF50; }
    #reset-button { background-color: var(--btn-reset-bg); }
    #undo-button { background-color: var(--btn-undo-bg); }

    #close-modal-button { background-color: #4a90e2; }
    #start-over-button { background-color: #4a90e2; }


    /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
    .modal {
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        display: none; /* JavaScriptã§è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ */
        justify-content: center;
        align-items: center;
    }
    #confetti-canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1001;
    }
    .modal-content {
        position: relative;
        z-index: 1002;
        background-color: var(--container-bg);
        padding: 30px 40px;
        border-radius: 15px;
        text-align: center;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        animation: slide-in 0.3s ease-out;
    }
    .modal-content h2 {
        font-size: 1.8em;
        margin: 0 0 25px;
    }

    @keyframes slide-in {
        from { transform: translateY(-30px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    /* ================================================================ */
    /* 5. è¿½åŠ ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆãƒ«ãƒ“ã€ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œï¼‰ */
    /* ================================================================ */

    ruby {
        font-size: inherit;
    }
    rt {
        font-size: 0.6em;
        font-weight: normal;
        opacity: 0.9;
    }

    #game-area {
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 450px;
        justify-content: center;
    }

    #game-board {
        margin: 10px auto;
    }
    </style>
</head>
<body>
    <!-- ç”»é¢å…¨ä½“ã®å…¥ã‚Œç‰© -->
    <div id="game-container">
        <h1 class="title">ãƒ‰ãƒƒãƒˆã‚¢ãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹</h1>

        <!-- ã‚²ãƒ¼ãƒ é–‹å§‹å‰ã®è¨­å®šç”»é¢ -->
        <div id="settings">
            <label for="board-size"><ruby>ç›¤é¢<rt>ã°ã‚“ã‚ã‚“</rt></ruby>ã®ã‚µã‚¤ã‚º (ãƒ‰ãƒƒãƒˆã®<ruby>æ•°<rt>ã‹ãš</rt></ruby>):</label>
            <select id="board-size">
                <option value="3">3x3</option>
                <option value="4" selected>4x4</option>
                <option value="5">5x5</option>
                <option value="6">6x6</option>
            </select>
            <button id="start-button" class="btn">ã‚²ãƒ¼ãƒ <ruby>é–‹å§‹<rt>ã‹ã„ã—</rt></ruby></button>
        </div>

        <!-- ã‚²ãƒ¼ãƒ ç”»é¢æœ¬ä½“ï¼ˆæœ€åˆã¯éè¡¨ç¤ºï¼‰ -->
        <div id="game-area" style="display:none;">
            <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ã¨ã‚¹ã‚³ã‚¢è¡¨ç¤º -->
            <div id="info-panel">
                <div id="player1-info" class="player-info">
                    ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1: <span id="player1-score" class="score">0</span>
                </div>
                <div id="player2-info" class="player-info">
                    ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2: <span id="player2-score" class="score">0</span>
                </div>
            </div>

            <!-- ã‚²ãƒ¼ãƒ ç›¤ï¼ˆãƒ‰ãƒƒãƒˆã‚„ç·šï¼‰ãŒè¡¨ç¤ºã•ã‚Œã‚‹å ´æ‰€ -->
            <div id="game-board"></div>
            
            <!-- æ“ä½œãƒœã‚¿ãƒ³ -->
            <div id="controls">
                <button id="reset-button" class="btn">ãƒªã‚»ãƒƒãƒˆ</button>
                <button id="undo-button" class="btn"><ruby>ä¸€æ‰‹<rt>ã„ã£ã¦</rt></ruby><ruby>æˆ»<rt>ã‚‚ã©</rt></ruby>ã™</button>
                <button id="start-over-button" class="btn">ã‚‚ã†<ruby>ä¸€åº¦<rt>ã„ã¡ã©</rt></ruby><ruby>éŠ<rt>ã‚ã</rt></ruby>ã¶</button>
            </div>
        </div>
    </div>

    <!-- å‹åˆ©è€…è¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆæœ€åˆã¯éè¡¨ç¤ºï¼‰ -->
    <div id="winner-modal" class="modal">
        <canvas id="confetti-canvas"></canvas>
        <div class="modal-content">
            <h2 id="winner-message"></h2>
            <button id="close-modal-button" class="btn"><ruby>é–‰<rt>ã¨</rt></ruby>ã˜ã‚‹</button>
        </div>
    </div>


    <!-- ================================================================ -->
    <!-- JavaScript: ã‚²ãƒ¼ãƒ ã®å‹•ãã‚’ä½œã‚‹ãƒ—ãƒ­ã‚°ãƒ©ãƒ  -->
    <!-- ================================================================ -->
    <script>
    // ================================================================
    // 1. ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨å®šæ•°
    // ================================================================
    
    let gameState = {};
    let moveHistory = [];
    let confetti = { animationId: null, particles: [], ctx: null };

    // ================================================================
    // 2. HTMLè¦ç´ ã®å–å¾—
    // ================================================================
    const settingsDiv = document.getElementById('settings');
    const gameAreaDiv = document.getElementById('game-area');
    const boardSizeSelect = document.getElementById('board-size');
    const startButton = document.getElementById('start-button');
    const boardElement = document.getElementById('game-board');
    const p1ScoreSpan = document.getElementById('player1-score');
    const p2ScoreSpan = document.getElementById('player2-score');
    const p1InfoDiv = document.getElementById('player1-info');
    const p2InfoDiv = document.getElementById('player2-info');
    const undoButton = document.getElementById('undo-button');
    const resetButton = document.getElementById('reset-button');
    const winnerModal = document.getElementById('winner-modal');
    const winnerMessage = document.getElementById('winner-message');
    const closeModalButton = document.getElementById('close-modal-button');
    const startOverButton = document.getElementById('start-over-button');
    const confettiCanvas = document.getElementById('confetti-canvas');


    // ================================================================
    // 3. ã‚²ãƒ¼ãƒ ã®åˆæœŸåŒ–ã¨ãƒªã‚»ãƒƒãƒˆ
    // ================================================================

    function startGame() {
        settingsDiv.style.display = 'none';
        gameAreaDiv.style.display = 'block';
        
        const selectedSize = parseInt(boardSizeSelect.value);
        initializeGame(selectedSize);
    }

    function initializeGame(size) {
        gameState = {
            boardSize: size,
            currentPlayer: 1,
            scores: { 1: 0, 2: 0 },
            lines: {
                horizontal: Array(size).fill(null).map(() => Array(size - 1).fill(false)),
                vertical: Array(size - 1).fill(null).map(() => Array(size).fill(false))
            },
            boxes: Array(size - 1).fill(null).map(() => Array(size - 1).fill(0))
        };
        
        moveHistory = [];
        
        updateScores();
        updateTurnIndicator();
        undoButton.disabled = true;
        winnerModal.style.display = 'none';
        stopConfetti();

        createBoard();
    }


    // ================================================================
    // 4. ç”»é¢ã®æç”»ãƒ»æ›´æ–°
    // ================================================================

    function createBoard() {
        boardElement.innerHTML = '';
        const size = gameState.boardSize;
        
        const BOARD_MAX_DIMENSION = Math.min(gameAreaDiv.clientWidth - 40, 450);
        const LINE_TO_DOT_RATIO = 3;
        const totalUnits = (size - 1) * LINE_TO_DOT_RATIO + size * 1;
        const unitPx = BOARD_MAX_DIMENSION / totalUnits;
        const lineLength = `${unitPx * LINE_TO_DOT_RATIO}px`;
        const dotAreaSize = `${unitPx * 1}px`;

        const gridTemplate = Array.from({ length: size * 2 - 1 }, (_, i) => 
            i % 2 === 0 ? dotAreaSize : lineLength
        ).join(' ');

        boardElement.style.gridTemplateColumns = gridTemplate;
        boardElement.style.gridTemplateRows = gridTemplate;

        for (let row = 0; row < size * 2 - 1; row++) {
            for (let col = 0; col < size * 2 - 1; col++) {
                const cell = document.createElement('div');
                
                if (row % 2 === 0 && col % 2 === 0) {
                    cell.className = 'dot';
                } 
                else if (row % 2 === 0 && col % 2 !== 0) {
                    cell.className = 'line horizontal';
                    cell.dataset.row = row / 2;
                    cell.dataset.col = (col - 1) / 2;
                    cell.onclick = () => onLineClick(cell, 'horizontal');
                } 
                else if (row % 2 !== 0 && col % 2 === 0) {
                    cell.className = 'line vertical';
                    cell.dataset.row = (row - 1) / 2;
                    cell.dataset.col = col / 2;
                    cell.onclick = () => onLineClick(cell, 'vertical');
                } 
                else {
                    cell.className = 'box-placeholder';
                    cell.dataset.row = (row - 1) / 2;
                    cell.dataset.col = (col - 1) / 2;
                }
                boardElement.appendChild(cell);
            }
        }
    }

    function updateScores() {
        p1ScoreSpan.textContent = gameState.scores[1];
        p2ScoreSpan.textContent = gameState.scores[2];
    }

    function updateTurnIndicator() {
        if (gameState.currentPlayer === 1) {
            p1InfoDiv.classList.add('active');
            p2InfoDiv.classList.remove('active');
        } else {
            p1InfoDiv.classList.remove('active');
            p2InfoDiv.classList.add('active');
        }
    }

    function fillBox(r, c) {
        const boxElement = document.querySelector(`.box-placeholder[data-row='${r}'][data-col='${c}']`);
        if (boxElement) {
            boxElement.classList.add(`filled-player${gameState.currentPlayer}`);
        }
    }


    // ================================================================
    // 5. ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
    // ================================================================

    function onLineClick(lineElement, type) {
        const row = parseInt(lineElement.dataset.row);
        const col = parseInt(lineElement.dataset.col);

        if ((type === 'horizontal' && gameState.lines.horizontal[row][col]) || 
            (type === 'vertical' && gameState.lines.vertical[row][col])) {
            return;
        }
        
        saveCurrentStateToHistory();

        drawLine(type, row, col, gameState.currentPlayer);

        const completedBoxesCount = checkForCompletedBoxes(type, row, col);

        if (completedBoxesCount === 0) {
            switchPlayer();
        }

        checkGameOver();
    }
    
    function undoMove() {
        if (moveHistory.length === 0) return;

        const lastFullState = moveHistory.pop();
        gameState = lastFullState.gameState;
        
        updateScores();
        updateTurnIndicator();
        
        redrawBoardFromState();
        
        if (moveHistory.length === 0) {
           undoButton.disabled = true;
        }
    }


    // ================================================================
    // 6. ã‚²ãƒ¼ãƒ é€²è¡Œã®ã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯
    // ================================================================
    
    function saveCurrentStateToHistory() {
        const deepCopiedGameState = JSON.parse(JSON.stringify(gameState));
        moveHistory.push({ gameState: deepCopiedGameState });
        undoButton.disabled = false;
    }
    
    function drawLine(type, row, col, player) {
        if (type === 'horizontal') {
            gameState.lines.horizontal[row][col] = true;
        } else {
            gameState.lines.vertical[row][col] = true;
        }
        const lineElement = document.querySelector(`.line.${type}[data-row='${row}'][data-col='${col}']`);
        if(lineElement) lineElement.classList.add(`player${player}`);
    }

    function switchPlayer() {
        gameState.currentPlayer = gameState.currentPlayer === 1 ? 2 : 1;
        updateTurnIndicator();
    }
    
    function redrawBoardFromState() {
        createBoard();

        const size = gameState.boardSize;
        for(let r = 0; r < size; r++) {
            for(let c = 0; c < size - 1; c++) {
                if(gameState.lines.horizontal[r][c]) {
                    const lineElem = document.querySelector(`.line.horizontal[data-row='${r}'][data-col='${c}']`);
                    if(lineElem) lineElem.classList.add('player-restored');
                }
            }
        }
        for(let r = 0; r < size - 1; r++) {
            for(let c = 0; c < size; c++) {
                if(gameState.lines.vertical[r][c]) {
                    const lineElem = document.querySelector(`.line.vertical[data-row='${r}'][data-col='${c}']`);
                    if(lineElem) lineElem.classList.add('player-restored');
                }
            }
        }
        
        for(let r = 0; r < size - 1; r++) {
            for(let c = 0; c < size - 1; c++) {
                const owner = gameState.boxes[r][c];
                if (owner > 0) {
                    const boxElement = document.querySelector(`.box-placeholder[data-row='${r}'][data-col='${c}']`);
                    if(boxElement) boxElement.classList.add(`filled-player${owner}`);
                }
            }
        }
    }


    // ================================================================
    // 7. ãƒ«ãƒ¼ãƒ«åˆ¤å®šï¼ˆãƒœãƒƒã‚¯ã‚¹å®Œæˆã€ã‚²ãƒ¼ãƒ çµ‚äº†ï¼‰
    // ================================================================

    function checkForCompletedBoxes(type, row, col) {
        let completedCount = 0;
        const size = gameState.boardSize;
        
        if (type === 'horizontal') {
            if (row > 0 && isBoxComplete(row - 1, col)) {
                if (gameState.boxes[row - 1][col] === 0) {
                    completeBox(row - 1, col);
                    completedCount++;
                }
            }
            if (row < size - 1 && isBoxComplete(row, col)) {
                if (gameState.boxes[row][col] === 0) {
                    completeBox(row, col);
                    completedCount++;
                }
            }
        } else { // vertical
            if (col > 0 && isBoxComplete(row, col - 1)) {
                if (gameState.boxes[row][col - 1] === 0) {
                    completeBox(row, col - 1);
                    completedCount++;
                }
            }
            if (col < size - 1 && isBoxComplete(row, col)) {
                if (gameState.boxes[row][col] === 0) {
                    completeBox(row, col);
                    completedCount++;
                }
            }
        }
        return completedCount;
    }

    function completeBox(r, c) {
        gameState.boxes[r][c] = gameState.currentPlayer;
        gameState.scores[gameState.currentPlayer]++;
        updateScores();
        fillBox(r, c);
    }
    
    function isBoxComplete(r, c) {
        return gameState.lines.horizontal[r][c] &&
               gameState.lines.horizontal[r + 1][c] &&
               gameState.lines.vertical[r][c] &&
               gameState.lines.vertical[r][c + 1];
    }
    
    function checkGameOver() {
        const size = gameState.boardSize;
        const totalBoxes = (size - 1) * (size - 1);
        const currentTotalScore = gameState.scores[1] + gameState.scores[2];

        if (currentTotalScore === totalBoxes) {
            endGame();
        }
    }
    
    function endGame() {
        let messageHTML = '';
        if (gameState.scores[1] > gameState.scores[2]) {
            messageHTML = `ğŸ‰ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ã®<ruby>å‹<rt>ã‹</rt></ruby>ã¡ï¼ ğŸ‰`;
        } else if (gameState.scores[2] > gameState.scores[1]) {
            messageHTML = `ğŸ‰ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2ã®<ruby>å‹<rt>ã‹</rt></ruby>ã¡ï¼ ğŸ‰`;
        } else {
            messageHTML = `<ruby>å¼•<rt>ã²</rt></ruby>ã<ruby>åˆ†<rt>ã‚</rt></ruby>ã‘ã§ã™ï¼`;
        }
        winnerMessage.innerHTML = messageHTML;
        winnerModal.style.display = 'flex';
        startConfetti();
        
        document.querySelectorAll('.line').forEach(line => line.onclick = null);
        undoButton.disabled = true;
    }


    // ================================================================
    // 9. å‹åˆ©æ¼”å‡ºï¼ˆç´™å¹é›ªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
    // ================================================================
    function startConfetti() {
        confetti.ctx = confettiCanvas.getContext('2d');
        confettiCanvas.width = window.innerWidth;
        confettiCanvas.height = window.innerHeight;
        confetti.particles = Array.from({ length: 150 }, createParticle);
        animateConfetti();
    }
    function stopConfetti() {
        if(confetti.animationId) cancelAnimationFrame(confetti.animationId);
        if (confetti.ctx) {
            confetti.ctx.clearRect(0, 0, window.innerWidth, window.innerHeight);
        }
    }
    function createParticle() {
        const colors = ["#E57373", "#64B5F6", "#FFD54F", "#81C784", "#FF80AB", "#9575CD"];
        return {
            x: Math.random() * confettiCanvas.width,
            y: Math.random() * confettiCanvas.height - confettiCanvas.height,
            size: Math.random() * 10 + 5,
            color: colors[Math.floor(Math.random() * colors.length)],
            speed: Math.random() * 3 + 2,
            angle: Math.random() * Math.PI * 2,
            spin: (Math.random() - 0.5) * 0.2
        };
    }
    function animateConfetti() {
        confetti.ctx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
        confetti.particles.forEach((p, i) => {
            p.y += p.speed;
            p.x += Math.sin(p.angle);
            p.angle += p.spin;
            confetti.ctx.fillStyle = p.color;
            confetti.ctx.save();
            confetti.ctx.translate(p.x, p.y);
            confetti.ctx.rotate(p.angle);
            confetti.ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size);
            confetti.ctx.restore();
            if (p.y > confettiCanvas.height) {
                confetti.particles[i] = createParticle();
                confetti.particles[i].y = -10;
            }
        });
        confetti.animationId = requestAnimationFrame(animateConfetti);
    }


    // ================================================================
    // 10. ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®ç™»éŒ²ã¨ã‚²ãƒ¼ãƒ é–‹å§‹
    // ================================================================
    startButton.addEventListener('click', startGame);
    resetButton.addEventListener('click', () => initializeGame(gameState.boardSize));
    undoButton.addEventListener('click', undoMove);
    
    startOverButton.addEventListener('click', () => {
        gameAreaDiv.style.display = 'none';
        settingsDiv.style.display = 'block';
    });

    closeModalButton.addEventListener('click', () => {
        winnerModal.style.display = 'none';
        stopConfetti();
    });
    
    </script>
</body>
</html>

